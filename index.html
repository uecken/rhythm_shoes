<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
  </head>
    <p>Rhythm!</p>
    <body>
        <div id="judge">
            jundge
        </div>
        <div id="good_result">
        good_result
        </div>
        <div id="bad_result">
        bad_result
        </div>

        <div class="media">
            <div id="songle">
            </div>
        </div>
        <p>リズムに合わせて、スマホを振ったり、画面をタップしてリズムゲームをしよう♪</p>
        <p>Date 2021/12/26 0:44</p>
        <div id="ac">
          acc
       </div>
        <!--<button onclick="eventAction()"> Smartphone-tap </button>-->
        <script src="https://api.songle.jp/v2/api.js"></script>
      </body>
</html>

  <script src="https://api.songle.jp/v2/api.js"></script>
  <script>
var beat_time = 0;
var beat_interval = 422;

self.onSongleAPIReady =
  function(Songle) {
    var player =
      new Songle.Player({
        mediaElement: "#songle"
      });

  　player.addPlugin(new Songle.Plugin.Beat({offset: -150}));      
    player.useMedia("https://www.youtube.com/watch?v=zweVJrnE1uY");
    //player.useMedia("www.nicovideo.jp%2Fwatch%2Fsm17762184");
    
    player.on("beatPlay",
      function(ev) {
        beat_time = Date.now();
        switch(ev.data.beat.position) {
          case 1:
            console.log("1st beat !!");
            break;

          case 2:
            console.log("2nd beat !!");
            break;

          case 3:
            console.log("3rd beat !!")
            break;

          case 4:
            console.log("4th beat !!");
            break;
        }
      });
  }
  
  
  var good_cnt=0;
  var bad_cnt =0;
  var audio_good = new Audio ('sound/button_25.mp3');
  var audio_bad = new Audio ('sound/button_34.mp3');


  function eventAction(){
           var event_time = Date.now();
           //console.log(event_time);
           delta_t = Math.abs(beat_time - event_time);
           if(delta_t < 100 || (delta_t + beat_interval) < 100){

             document.getElementById("judge").innerHTML = "Good♪";
             //console.log("Gooooood");
             good_cnt++;
             document.getElementById("good_result").innerHTML = good_cnt;
             //audio.pause();
             audio_good.currentTime = 0;
             audio_good.play();
}else{
             document.getElementById("judge").innerHTML = "bad...";
　					 //console.log("bad");
             bad_cnt++;
             document.getElementById("bad_result").innerHTML = bad_cnt;
             audio_bad.currentTime = 0;
             audio_bad.play();
           }
    return null;
  }

  document.body.addEventListener('keydown',
    event => {
        if (event.key === 'v' && event.ctrlKey || event.key === 'e' ) {
          eventAction();
        }
    });

    document.body.addEventListener('click', function(){
      eventAction();
    });


    //===========Smartphone Event Listener============    
    /*document.body.addEventListener('touchstart', function(){
      eventAction();
    });*/

    //===========ACC Event Listener============
    /*
    var previousAccTime =0;
    window.addEventListener( "devicemotion", function( event ){
      var now = Date.now();
      if (now - previousAccTime > 250){
        previousAccTime = now;
        var x = event.accelerationIncludingGravity.x;
        var y = event.accelerationIncludingGravity.y;
        var z = event.accelerationIncludingGravity.z;
        ac = Math.round(Math.sqrt(x*x + y*y + z*z));
        console.log(ac);
        if(ac >= 20){
          document.getElementById("ac").innerHTML = "acc:"+String(ac);
          eventAction();
        }
      }
    });
    */

  </script>