<html>
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <title>Rhythm Shoes</title>
   </head>
    <body>
      <h1>Rhythm Shoes</h1>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

      <p>リズムに合わせ画面をタップしてリズムゲームをしよう♪</p>
      <div>
        <span class="badge bg-primary">
          beat
          <span id="beat" class="badge bg-secondary">1</span> 
        </span>
        <div id="judge">jundge</div>
        <!--
        <div id="beat">beat</div>
        <div id="timing_diff">timing</div>
        <div id="good_result">good_result</div>
        <div id="bad_result">bad_result</div>
        -->
        <button type="button" class="btn btn-primary position-relative">
          Good
          <span id="good_result" class="position-absolute top-0 start-90 translate-middle badge rounded-pill bg-danger">
            0
            <span class="visually-hidden">unread messages</span>
          </span>
        </button>
        <button type="button" class="btn  btn-secondary  position-relative">
          Bad
          <span id="bad_result" class="position-absolute top-0 start-90 translate-middle badge rounded-pill bg-danger">
            0
            <span class="visually-hidden">unread messages</span>
          </span>
        </button>
        <span class="badge bg-primary">
          timing <span id="timing_diff" class="badge bg-success">0</span>
        </span>


      </div>
      <div class="media">
            <div id="songle"></div>
      </div>
      <div>各種設定
        <div id="acc">acc</div>
        <div id="beat_offset">beat_offset(未実装)</div>
        <div id="rhythm_judge_range">rhythm judgea range</div>
        <button type="button" class="btn btn-outline-primary" onclick="beat_timing_offset(10)" id="beat_offset+"> beat offset+ </button>
        <button type="button" class="btn btn-outline-primary" onclick="beat_timing_offset(-10)" id="beat_offset-"> beat offset- </button>
        <br>
        <button type="button" class="btn btn-outline-success" onclick="rhythm_judge_range_offset(10)" id="rhythm_range+">rhythm_range+</button>
        <button type="button" class="btn btn-outline-success" onclick="rhythm_judge_range_offset(-10)" id="rhythm_range+">rhythm_range-</button>
      </div>

      <br>
      <div>開発状況
        <ul class="list-group">
         <li class="list-group-item">更新日:2021/12/26 11:60</li>
         <li class="list-group-item">スマホで加速度eventを使う場合レートを落とさないと他処理が遅くなるため今は使わない</li>
         <li class="list-group-item">GitHub Pagesでファイル更新した際にすぐ反映させるには、末尾に?=version={commitID}を付ける</li>
         <li class="list-group-item">https://example.github.io/index.html?version=a1b2c3d</li>
         <li class="list-group-item">開始前やリアルタイムにbeat_offset設定可能か検討する</li>
        </ul>
      </div>

       <!--<button onclick="eventAction()"> Smartphone-tap </button>-->
        <script src="https://api.songle.jp/v2/api.js"></script>
      </body>
</html>

<script>
var beat_time = 0;
var beat_interval = 422;
var beat_offset = -150;
beat_obj = document.getElementById("beat");
beat_offset_obj = document.getElementById("beat_offset");
rhythm_judge_range_obj = document.getElementById("rhythm_judge_range");


//======beat offsetするには、playerインスタンスを外で生成する必要がある==========
self.onSongleAPIReady =
  function(Songle) {
    var player =
      new Songle.Player({
        mediaElement: "#songle"
      });

  　player.addPlugin(new Songle.Plugin.Beat({offset: beat_offset}));      
    player.useMedia("https://www.youtube.com/watch?v=zweVJrnE1uY");
    //player.useMedia("www.nicovideo.jp%2Fwatch%2Fsm17762184");
    
    player.on("beatPlay",
      function(ev) {
        beat_time = Date.now();
        switch(ev.data.beat.position) {
          case 1:
            console.log("1st beat !!");
            beat_obj.innerHTML = "1";            
            break;

          case 2:
            console.log("2nd beat !!");
            beat_obj.innerHTML = "2";            
            break;

          case 3:
            console.log("3rd beat !!")
            beat_obj.innerHTML = "3";            
            break;

          case 4:
            console.log("4th beat !!");
            beat_obj.innerHTML = "4"; 
            break;
        }
      });
  }
  
  
  var good_cnt=0;
  var bad_cnt =0;
  var audio_good = new Audio ('sound/button_25.mp3');
  var audio_bad = new Audio ('sound/button_34.mp3');
  var judge_obj = document.getElementById("judge");
  var timing_diff_obj = document.getElementById("timing_diff");
  var good_result_obj = document.getElementById("good_result");
  var bad_result_obj = document.getElementById("bad_result");
  var rhythm_judge_range = 100;
  function eventAction(rhythm_judge_range){
           var event_time = Date.now();
           console.log(event_time);
           delta_t = beat_time - event_time;
           delta_t_prev = delta_t + beat_interval;
           console.log(delta_t);
           console.log(delta_t_prev);
           if(Math.abs(delta_t) < rhythm_judge_range  || Math.abs(delta_t_prev) < rhythm_judge_range){
             judge_obj.innerHTML = "Good♪";
             console.log("Gooooood");
             good_cnt++;
             good_result_obj.innerHTML = good_cnt;
             //audio.pause();
             audio_good.currentTime = 0;
             audio_good.play();
          }else{
             judge_obj.innerHTML = "bad...";
　					 //console.log("bad");
             bad_cnt++;
             bad_result_obj.innerHTML = bad_cnt;
             audio_bad.currentTime = 0;
             audio_bad.play();
           }

           //=====判定誤差表示====
           if(Math.abs(delta_t) < Math.abs(delta_t_prev)){
            timing_diff_obj.innerHTML = delta_t;
           }else{
            timing_diff_obj.innerHTML = delta_t_prev; 
           }
    return null;
  }

  document.body.addEventListener('keydown',
    event => {
        if (event.key === 'v' && event.ctrlKey || event.key === 'e' ) {
          eventAction(rhythm_judge_range);
        }
    });

    document.body.addEventListener('click', function(){
      eventAction(rhythm_judge_range);
    });

  function beat_timing_offset(offset){
    beat_offset = beat_offset + offset;
    beat_offset_obj.innerHTML = beat_offset+"ms";
  }

  function rhythm_judge_range_offset(offset){
    rhythm_judge_range = rhythm_judge_range + offset;
    rhythm_judge_range_obj.innerHTML = rhythm_judge_range+"ms";
  }
    //===========Smartphone Event Listener============    
    /*document.body.addEventListener('touchstart', function(){
      eventAction();
    });*/

    //===========ACC Event Listener============
    /*
    var previousAccTime =0;
    window.addEventListener( "devicemotion", function( event ){
      var now = Date.now();
      if (now - previousAccTime > 250){
        previousAccTime = now;
        var x = event.accelerationIncludingGravity.x;
        var y = event.accelerationIncludingGravity.y;
        var z = event.accelerationIncludingGravity.z;
        ac = Math.round(Math.sqrt(x*x + y*y + z*z));
        console.log(ac);
        if(ac >= 20){
          document.getElementById("acc").innerHTML = "acc:"+String(ac);
          eventAction();
        }
      }
    });
    */

  </script>